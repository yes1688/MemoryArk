version: '3.8'

services:
  # æ•´åˆæ¸¬è©¦å®¹å™¨ - å°ç”Ÿç”¢ç’°å¢ƒé€²è¡Œæ¸¬è©¦
  integration-test:
    build:
      context: .
      dockerfile: Dockerfile.integration-test
    environment:
      # æ¸¬è©¦ç›®æ¨™ä¼ºæœå™¨
      - API_BASE_URL=http://host.docker.internal:7001
      - TEST_ENVIRONMENT=integration
      # æ¸¬è©¦ç”¨æˆ¶æ†‘è­‰
      - TEST_ADMIN_EMAIL=94work.net@gmail.com
      - TEST_USER_EMAIL=test-user@example.com
      # æ¸¬è©¦è¨­å®š
      - TEST_TIMEOUT=30
      - TEST_PARALLEL=false
    volumes:
      - ./testing:/app/testing
      - ./testing/test-results:/app/test-results
    extra_hosts:
      # è®“å®¹å™¨å¯ä»¥è¨ªå•ä¸»æ©Ÿçš„ localhost
      - "host.docker.internal:host-gateway"
    command: |
      sh -c "
        echo 'ğŸ§ª é–‹å§‹åŸ·è¡Œæ•´åˆæ¸¬è©¦...'
        echo 'ğŸ¯ ç›®æ¨™ä¼ºæœå™¨: ${API_BASE_URL}'
        echo 'â³ ç­‰å¾…ä¼ºæœå™¨å°±ç·’...'
        
        # ç­‰å¾…æœå‹™å°±ç·’
        until curl -s ${API_BASE_URL}/api/health > /dev/null; do
          echo 'ç­‰å¾…æœå‹™å•Ÿå‹•...'
          sleep 2
        done
        
        echo 'âœ… æœå‹™å·²å°±ç·’ï¼Œé–‹å§‹æ¸¬è©¦'
        
        # åŸ·è¡Œæ¸¬è©¦
        cd /app/testing
        python3 run-integration-tests.py
        
        # ç”¢ç”Ÿæ¸¬è©¦å ±å‘Š
        echo 'ğŸ“Š ç”¢ç”Ÿæ¸¬è©¦å ±å‘Š...'
        python3 generate-test-report.py
        
        echo 'âœ… æ¸¬è©¦å®Œæˆï¼å ±å‘Šå·²å„²å­˜è‡³ /app/test-results/'
      "
    networks:
      - test-network

  # æ¸¬è©¦å ±å‘Šæª¢è¦–æœå‹™
  test-report-viewer:
    image: nginx:alpine
    ports:
      - "8081:80"
    volumes:
      - ./testing/test-results:/usr/share/nginx/html:ro
    profiles:
      - report
    networks:
      - test-network

networks:
  test-network:
    driver: bridge