# MemoryArk 2.0 後端 API 分析報告

## 系統概述

MemoryArk 2.0 是一個教會影音回憶錄系統，使用 Go 語言開發的 RESTful API 後端。

### 技術架構
- **語言**: Go
- **資料庫**: SQLite
- **認證**: Cloudflare Access (Header-based)
- **檔案儲存**: 本地檔案系統 + SHA256 去重
- **API 格式**: JSON RESTful API

## API 端點分析

### 1. 公開端點（無需認證）

| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| GET | `/api/health` | 健康檢查 | 服務狀態、回應格式 |
| GET | `/api/auth/status` | 認證狀態檢查 | 註冊狀態、用戶資訊 |
| POST | `/api/auth/register` | 用戶註冊 | 輸入驗證、重複註冊 |

### 2. 認證端點

| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| GET | `/api/auth/me` | 取得當前用戶 | 權限驗證、資料正確性 |

### 3. 檔案管理端點

#### 基本操作
| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| GET | `/api/files` | 檔案列表 | 分頁、篩選、排序 |
| GET | `/api/files/:id` | 檔案詳情 | 權限檢查、錯誤處理 |
| POST | `/api/files/upload` | 檔案上傳 | 去重機制、大小限制、類型驗證 |
| PUT | `/api/files/:id` | 更新檔案 | 權限檢查、併發處理 |
| DELETE | `/api/files/:id` | 刪除檔案 | 軟刪除機制、權限驗證 |

#### 進階操作
| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| POST | `/api/files/:id/restore` | 還原檔案 | 狀態驗證、權限檢查 |
| DELETE | `/api/files/:id/permanent` | 永久刪除 | 二次確認、實體檔案清理 |
| GET | `/api/files/:id/download` | 下載檔案 | 斷點續傳、權限驗證 |
| POST | `/api/files/:id/share` | 建立分享連結 | 連結有效性、權限控制 |

### 4. 資料夾管理端點

| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| POST | `/api/folders` | 建立資料夾 | 路徑驗證、重複檢查 |
| PUT | `/api/folders/:id/move` | 移動檔案/資料夾 | 循環引用、權限檢查 |
| PUT | `/api/folders/:id/rename` | 重新命名 | 名稱驗證、衝突處理 |

### 5. 分類管理端點

| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| GET | `/api/categories` | 分類列表 | 階層結構、排序 |
| POST | `/api/categories` | 建立分類 | 名稱唯一性、階層限制 |
| PUT | `/api/categories/:id` | 更新分類 | 關聯影響、權限控制 |
| DELETE | `/api/categories/:id` | 刪除分類 | 關聯檔案處理、軟刪除 |

### 6. 匯出功能端點

| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| POST | `/api/export/stream` | 串流匯出 | 大量資料處理、記憶體控制 |
| GET | `/api/export/quick` | 快速匯出 | 預設篩選、效能優化 |
| GET | `/api/export/status/:jobId` | 匯出狀態 | 進度追蹤、錯誤處理 |
| GET | `/api/export/download/:jobId` | 下載匯出 | 檔案完整性、清理機制 |

### 7. 管理員端點

#### 用戶管理
| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| GET | `/api/admin/users` | 用戶列表 | 權限驗證、資料過濾 |
| PUT | `/api/admin/users/:id/role` | 更新角色 | 權限提升、自我修改限制 |
| PUT | `/api/admin/users/:id/status` | 更新狀態 | 狀態轉換、影響驗證 |

#### 系統管理
| 方法 | 路徑 | 功能 | 測試重點 |
|------|------|------|----------|
| GET | `/api/admin/stats` | 系統統計 | 資料準確性、效能 |
| GET | `/api/admin/logs` | 活動日誌 | 日誌完整性、隱私保護 |

## 認證機制分析

### Cloudflare Access 認證
- **Header 檢查**: `CF-Access-Authenticated-User-Email`
- **開發模式**: 可繞過 Cloudflare 認證
- **角色系統**: admin / user 兩種角色

### 測試考量
1. **Header 偽造測試**: 確保無法偽造認證 header
2. **權限邊界測試**: 驗證角色權限正確性
3. **Session 管理**: 測試認證狀態持久性

## 關鍵功能測試重點

### 1. 檔案去重機制
- **SHA256 驗證**: 相同檔案不重複儲存
- **並發上傳**: 同時上傳相同檔案的處理
- **去重統計**: 驗證儲存空間節省

### 2. 虛擬路徑系統
- **路徑獨立性**: 虛擬路徑與實體儲存分離
- **路徑操作**: 移動、重新命名的正確性
- **路徑衝突**: 同名路徑的處理

### 3. 軟刪除機制
- **狀態管理**: 刪除標記的正確性
- **還原功能**: 確保資料可完整還原
- **永久刪除**: 實體檔案的清理

### 4. 匯出系統
- **大量資料**: 測試數萬筆資料的匯出
- **記憶體控制**: 確保不會 OOM
- **並發匯出**: 多用戶同時匯出的處理

## 錯誤處理測試

### 標準錯誤回應格式
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "錯誤描述",
    "details": "詳細資訊"
  }
}
```

### 常見錯誤碼
- `UNAUTHORIZED`: 未認證
- `FORBIDDEN`: 無權限
- `NOT_FOUND`: 資源不存在
- `VALIDATION_ERROR`: 輸入驗證失敗
- `INTERNAL_ERROR`: 伺服器內部錯誤

## 效能測試考量

1. **並發處理**: 測試高並發請求的處理能力
2. **大檔案上傳**: 測試 GB 級檔案的處理
3. **資料庫查詢**: 大量資料的查詢效能
4. **記憶體使用**: 確保無記憶體洩漏

## 安全測試重點

1. **SQL Injection**: 所有輸入參數的安全性
2. **Path Traversal**: 檔案路徑的安全驗證
3. **權限提升**: 確保無法越權存取
4. **資料洩漏**: 敏感資訊的保護

## 測試資料準備

### 測試用戶
- 管理員用戶
- 一般用戶
- 待審核用戶
- 已停用用戶

### 測試檔案
- 各種檔案類型（圖片、影片、文件）
- 不同大小的檔案（KB 到 GB）
- 特殊字元檔名
- 重複內容檔案（測試去重）

### 測試分類
- 多層級分類結構
- 包含大量檔案的分類
- 空分類

## 下一步行動

1. 設定 httptest + testify 測試框架
2. 建立測試資料產生器
3. 實作各端點的單元測試
4. 實作整合測試案例
5. 建立效能測試基準