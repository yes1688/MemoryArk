version: '3.8'

services:
  # 測試用後端容器
  backend-test:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.test
    environment:
      - ENVIRONMENT=test
      - DATABASE_PATH=/app/test-data/test.db
      - UPLOAD_PATH=/app/test-data/uploads
      - LOG_PATH=/app/test-data/logs
      - ROOT_ADMIN_EMAIL=test-admin@example.com
      - CLOUDFLARE_AUTH_ENABLED=false
      - JWT_SECRET=test-secret-key-for-testing-only
      - PORT=7002
      - HOST=0.0.0.0
    volumes:
      - ./testing:/app/testing
      - ./backend:/app/backend
    working_dir: /app/backend
    command: |
      sh -c "
        echo '🧪 開始執行後端測試...'
        go test ./testing/backend-tests/... -v -coverprofile=/app/testing/coverage.out
        go tool cover -html=/app/testing/coverage.out -o /app/testing/coverage.html
        echo '✅ 測試完成！覆蓋率報告已產生'
      "
    networks:
      - test-network

  # 測試用前端容器（E2E 測試）
  frontend-test:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend-test
    environment:
      - CI=true
      - VITE_API_URL=http://backend-test:7002
    volumes:
      - ./testing:/app/testing
      - ./frontend:/app/frontend
    depends_on:
      - backend-test
    command: |
      sh -c "
        echo '🎭 等待後端服務啟動...'
        sleep 10
        echo '🧪 開始執行 E2E 測試...'
        npm run test:e2e
        echo '✅ E2E 測試完成！'
      "
    networks:
      - test-network

  # 測試報告服務器（可選）
  test-report:
    image: nginx:alpine
    volumes:
      - ./testing:/usr/share/nginx/html:ro
    ports:
      - "8080:80"
    networks:
      - test-network
    profiles:
      - report

networks:
  test-network:
    driver: bridge