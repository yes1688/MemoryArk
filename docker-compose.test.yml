version: '3.8'

services:
  # æ¸¬è©¦ç”¨å¾Œç«¯å®¹å™¨
  backend-test:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.test
    environment:
      - ENVIRONMENT=test
      - DATABASE_PATH=/app/test-data/test.db
      - UPLOAD_PATH=/app/test-data/uploads
      - LOG_PATH=/app/test-data/logs
      - ROOT_ADMIN_EMAIL=test-admin@example.com
      - CLOUDFLARE_AUTH_ENABLED=false
      - JWT_SECRET=test-secret-key-for-testing-only
      - PORT=7002
      - HOST=0.0.0.0
    volumes:
      - ./testing:/app/testing
      - ./backend:/app/backend
    working_dir: /app/backend
    command: |
      sh -c "
        echo 'ğŸ§ª é–‹å§‹åŸ·è¡Œå¾Œç«¯æ¸¬è©¦...'
        go test ./testing/backend-tests/... -v -coverprofile=/app/testing/coverage.out
        go tool cover -html=/app/testing/coverage.out -o /app/testing/coverage.html
        echo 'âœ… æ¸¬è©¦å®Œæˆï¼è¦†è“‹ç‡å ±å‘Šå·²ç”¢ç”Ÿ'
      "
    networks:
      - test-network

  # æ¸¬è©¦ç”¨å‰ç«¯å®¹å™¨ï¼ˆE2E æ¸¬è©¦ï¼‰
  frontend-test:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend-test
    environment:
      - CI=true
      - VITE_API_URL=http://backend-test:7002
    volumes:
      - ./testing:/app/testing
      - ./frontend:/app/frontend
    depends_on:
      - backend-test
    command: |
      sh -c "
        echo 'ğŸ­ ç­‰å¾…å¾Œç«¯æœå‹™å•Ÿå‹•...'
        sleep 10
        echo 'ğŸ§ª é–‹å§‹åŸ·è¡Œ E2E æ¸¬è©¦...'
        npm run test:e2e
        echo 'âœ… E2E æ¸¬è©¦å®Œæˆï¼'
      "
    networks:
      - test-network

  # æ¸¬è©¦å ±å‘Šæœå‹™å™¨ï¼ˆå¯é¸ï¼‰
  test-report:
    image: nginx:alpine
    volumes:
      - ./testing:/usr/share/nginx/html:ro
    ports:
      - "8080:80"
    networks:
      - test-network
    profiles:
      - report

networks:
  test-network:
    driver: bridge