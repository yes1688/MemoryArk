# Phase 2: 資料庫設計與遷移

## 📋 階段概述

建立 LINE 功能所需的資料庫結構，包含 7 張新資料表和相關索引，並實作完整的遷移腳本。

**預估時間**：2-3 天  
**依賴關係**：Phase 1 完成  
**輸出物**：資料庫結構、遷移腳本、GORM 模型

## 🎯 主要子任務

### 2.1 資料庫設計與模型定義
- **檔案**：`task-2.1-database-design.md`
- **時間**：1 天
- **責任**：後端開發者 + 資料庫管理員

### 2.2 GORM 模型實作
- **檔案**：`task-2.2-gorm-models.md`
- **時間**：0.5 天
- **責任**：後端開發者

### 2.3 資料庫遷移腳本
- **檔案**：`task-2.3-database-migration.md`
- **時間**：0.5 天
- **責任**：後端開發者

### 2.4 UUID v7 實作與整合
- **檔案**：`task-2.4-uuid-v7-implementation.md`
- **時間**：0.5 天
- **責任**：後端開發者

### 2.5 資料庫測試與驗證
- **檔案**：`task-2.5-database-testing.md`
- **時間**：0.5 天
- **責任**：QA + 後端開發者

## 📊 資料表概覽

### 新增資料表 (7 張)
1. **`line_upload_records`** - 主要上傳記錄 (UUID v7 主鍵)
2. **`line_users`** - LINE 用戶資訊
3. **`line_groups`** - LINE 群組資訊
4. **`line_group_members`** - 群組成員關聯
5. **`line_webhook_logs`** - Webhook 事件日誌
6. **`line_settings`** - 系統設定
7. **`line_upload_stats`** - 統計快取表

### 關聯關係
```
files (原有表)
  ↑
  │ (file_id)
  │
line_upload_records ──────┐
  ↑                      │
  │ (line_user_id)        │ (line_group_id)
  │                      ↓
line_users            line_groups
  ↑                      ↑
  │                      │
  └──── line_group_members ──┘
```

## ✅ 完成標準

- [ ] 所有 7 張資料表建立成功
- [ ] 索引和外鍵約束設定正確
- [ ] GORM 模型與資料表對應
- [ ] UUID v7 生成功能正常
- [ ] 遷移腳本可重複執行
- [ ] 資料庫備份機制就緒
- [ ] 測試資料正確插入和查詢

## 🔧 關鍵技術要求

- SQLite 3.35+ (支援 JSON 欄位)
- GORM v2 最新版本
- UUID v7 套件整合
- 事務管理機制
- 索引優化策略

## 📊 效能指標

| 操作類型 | 目標效能 | 測試方法 |
|---------|---------|---------|
| 插入單筆記錄 | < 10ms | 壓力測試 |
| 查詢用戶記錄 | < 50ms | 分頁查詢 |
| 統計數據查詢 | < 100ms | 複雜查詢 |
| 批量操作 | < 1s/1000筆 | 批量插入 |

## 🚨 風險評估

| 風險項目 | 影響等級 | 緩解措施 |
|---------|---------|---------|
| 資料庫遷移失敗 | 高 | 完整備份 + 回滾機制 |
| 索引效能問題 | 中 | 測試環境驗證 |
| 外鍵約束衝突 | 中 | 循序建立約束 |
| UUID v7 相容性 | 低 | 降級方案準備 |

## 📋 檢查清單

### 開發階段
- [ ] 資料表 DDL 設計完成
- [ ] GORM 模型實作完成
- [ ] 遷移腳本撰寫完成
- [ ] 單元測試撰寫完成

### 測試階段
- [ ] 本地環境測試通過
- [ ] 效能測試達標
- [ ] 資料完整性驗證
- [ ] 回滾測試成功

### 部署階段
- [ ] 生產環境備份完成
- [ ] 遷移腳本執行成功
- [ ] 資料驗證通過
- [ ] 監控告警設定

## 📞 支援資源

- GORM 文檔：https://gorm.io/docs/
- SQLite 文檔：https://sqlite.org/docs.html
- UUID v7 規範：RFC 9562
- 資料庫設計最佳實務

---

**狀態**：待開始  
**負責人**：後端團隊  
**開始日期**：待定  
**完成日期**：待定