# LINE 信徒照片上傳功能需求規格

**需求提出時間**: 2025-06-27 21:44  
**當前狀態**: 基礎功能已實作，需要增強記錄和組織功能

---

## 🎯 核心需求

### 1. 用戶資訊保存
- **保存 LINE 用戶 ID**: 唯一識別 LINE 用戶
- **保存用戶名稱**: LINE 顯示名稱（displayName）

### 2. 檔案組織結構
**目標結構**:
```
📁 line信徒照片上傳/
  ├── 📁 王小明/
  │   ├── 📷 2025-06-27_照片1.jpg
  │   └── 📷 2025-06-27_照片2.jpg
  ├── 📁 李美華/
  │   └── 📷 2025-06-27_照片3.jpg
  └── 📁 陳志豪/
      └── 📷 2025-06-27_照片4.jpg
```

**需求細節**:
- 建立頂層資料夾「line信徒照片上傳」
- 按照 LINE 用戶姓名建立子資料夾
- 照片自動放入對應用戶的資料夾中
- 在後端管理介面「檔案管理」中可見此結構

---

## 🔍 當前狀況

### ✅ 已實作功能
1. **照片上傳流程**: LINE → MemoryArk 成功
2. **基礎檔案保存**: 照片已保存到 uploads/files/ 目錄
3. **用戶資訊擷取**: LINE Service 已能取得用戶詳細資訊
4. **認證機制**: API Token 認證正常運作

### ❌ 待實作功能
1. **用戶記錄表**: `line_users` 表目前為空
2. **上傳記錄表**: `line_upload_records` 表目前為空  
3. **虛擬路徑組織**: 照片散亂保存，未按用戶分類
4. **資料夾結構**: 缺少「line信徒照片上傳」頂層資料夾

---

## 📊 技術架構分析

### 當前檔案保存方式
```bash
# 目前
uploads/files/ab/f5f175ef-c32c-4b32-87e0-168f49baa78e  # 散亂保存

# 期望
virtual_path: /line信徒照片上傳/王小明/line_567406120168063198_1751031708269.jpg
```

### 數據庫表結構
```sql
-- files 表 (主檔案記錄)
SELECT id, name, virtual_path, uploaded_by FROM files WHERE id = 106;
-- 結果: 106|line_567406120168063198_1751031708269.jpg||0

-- line_users 表 (LINE 用戶記錄) - 目前為空
-- line_upload_records 表 (上傳記錄) - 目前為空
```

---

## 🚀 實作目標

### Phase 1: 資料結構完善
1. **建立 LINE 用戶記錄**: 保存 userId 和 displayName
2. **建立上傳記錄**: 關聯檔案 ID 和 LINE 用戶 ID
3. **設定虛擬路徑**: 使用 virtual_path 實現資料夾結構

### Phase 2: 檔案組織優化
1. **創建頂層資料夾**: 「line信徒照片上傳」
2. **用戶子資料夾**: 按 displayName 自動分類
3. **後台介面整合**: 在管理介面中正確顯示結構

### Phase 3: 歷史資料遷移
1. **現有照片重新組織**: 將已上傳的照片移入正確資料夾
2. **資料完整性確保**: 確保所有記錄正確關聯

---

## 💡 預期效益

### 管理效率提升
- **用戶識別**: 清楚知道每張照片的上傳者
- **檔案組織**: 按用戶分類，便於管理和查找
- **統計分析**: 可統計各用戶的上傳量和活躍度

### 用戶體驗改善
- **個人檔案**: 每位信徒有專屬的照片資料夾
- **隱私保護**: 清楚的權限和分類管理
- **歷史追蹤**: 完整的上傳記錄和時間軸

---

## 🔧 技術考量

### 虛擬路徑 vs 實體路徑
- 使用 MemoryArk 既有的 `virtual_path` 功能
- 實體檔案仍分散儲存（去重、效能考量）
- 虛擬路徑提供邏輯上的資料夾結構

### 用戶名稱處理
- 使用 LINE displayName 作為資料夾名稱
- 處理特殊字元和重複名稱
- 考慮 displayName 變更的情況

### 向後相容性
- 不影響現有檔案管理功能
- 保持 MemoryArk 原有架構不變
- LINE 功能作為附加模組

---

**優先級**: 🔥 高優先級  
**預估複雜度**: 🟨 中等複雜度  
**影響範圍**: LINE Service + Backend API + Database Schema